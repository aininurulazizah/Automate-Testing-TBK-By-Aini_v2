name: Run Playwright Tests

on:
  workflow_dispatch:
    inputs:
      test_file:
        description: "Spec file yang mau dijalankan"
        required: false
        default: ""
  schedule:
    - cron: "0 2 * * *"

jobs:
  run-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install dependecies
        run: npm install

      - name: Install Playwright Browser
        run: npx playwright install chromium

      - name: Run tests
        id: run_tests
        run: |
          if [ -z "${{ github.event.inputs.test_file }}" ]; then
            echo "Running all tests..."
            npx playwright test --reporter=json --project=chromium > result.json || true
            echo "Done running all tests"
          else
            echo "Running test file: ${{ github.event.inputs.test_file }}"
            npx playwright test ./tests/${{ github.event.inputs.test_file }} --reporter=json --project=chromium > result.json || true
            echo "Done running specific test: ${{ github.event.inputs.test_file }}"
          fi
        continue-on-error: true

      - name: Generate test summary
        run: |
          PASSED=$(jq '[.suites[].specs[].tests[].results[] | select(.status=="passed")] | length' result.json)
          FAILED=$(jq '[.suites[].specs[].tests[].results[] | select(.status=="failed")] | length' result.json)
          TOTAL=$((PASSED + FAILED))

          echo "PASSED=$PASSED" >> $GITHUB_ENV
          echo "FAILED=$FAILED" >> $GITHUB_ENV
          echo "TOTAL=$TOTAL" >> $GITHUB_ENV

      - name: Generate HTML report
        run: npx playwright show-report --output=report

      - name: Deploy report to Github Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./report

      - name: Send Telegram Notification
        if: always()
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="ðŸ§ª *Playwright Test Result*

            Status: ${{ job.status }}
            Total: $TOTAL
            Passed: $PASSED
            Failed: $FAILED

            Triggered by: ${{ github.actor }}
            Workflow: ${{ github.workflow }}
            Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
            Report: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
